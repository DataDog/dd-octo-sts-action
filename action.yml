# Copyright 2024 Chainguard, Inc.
# SPDX-License-Identifier: Apache-2.0

name: "Octo STS"
description: |
  This action exchanges the workflow's identity token for a Github App token
  from the Octo STS service, in accordance with the trust policy of the target
  organization or repository.

inputs:
  domain:
    description: |
      The domain of the Octo STS instance to use to federate.
    default: webhooks.build.datadoghq.com

  audience:
    description: |
      The audience of the Octo STS instance to use.
    default: dd-octo-sts

  scope:
    description: |
      The scope to request access to. Must be "org" for organization-scoped tokens or
      "org/repo" for repository-scoped tokens. Mutually exclusive with scope_enterprise.
    required: false

  policy:
    description: |
      The name of the trust policy to load from the target repository. The trust policy
      is loaded from https://github.com/{scope} from the file
      .github/chainguard/{identity}.sts.yaml
    required: true

  pool_name:
    description: |
      The name of the application pool to use. When provided, the pool endpoint is used
      instead of the legacy endpoint. Mutually exclusive with application_id.
    required: false

  application_id:
    description: |
      A specific application ID to use with the pool endpoint. When provided, the pool
      endpoint is used instead of the legacy endpoint. Mutually exclusive with pool_name.
    required: false

  scope_enterprise:
    description: |
      Enterprise slug for enterprise-level tokens (pool endpoint only).
      Mutually exclusive with scope.
    required: false

outputs:
  token:
    description: |
      The federated token to use for authentication.
    value: ${{ steps.octo-sts.outputs.token }}

runs:
  using: "node20"
  main: "index.js"
  post: "post.js"
